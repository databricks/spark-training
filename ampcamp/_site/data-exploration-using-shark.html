<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" xmlns="http://www.w3.org/1999/html"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Data Exploration Using Shark</title>
        <meta name="description" content="">

        <!--<link rel="stylesheet" href="css/vendor/bootstrap/bootstrap.min.css">-->
        <link rel="stylesheet" href="css/vendor/bootstrap/bootstrap.css">
        <meta name="viewport" content="width=device-width">
        <!--<link rel="stylesheet" href="css/vendor/bootstrap/bootstrap-responsive.min.css">-->
        <link rel="stylesheet" href="css/vendor/bootstrap/bootstrap-responsive.css">
        <link rel="stylesheet" href="css/vendor/font-awesome.min.css">
        <!--[if IE 7]>
        <link rel="stylesheet" href="assets/css/vendorfont-awesome-ie7.min.css">
        <![endif]-->
        <link rel="stylesheet" href="css/main.css">

        <script src="js/vendor/modernizr-2.6.1-respond-1.1.0.min.js"></script>

         <!-- prettify js and CSS, used for code highlighting -->
        <link rel="stylesheet" href="css/vendor/prettify/prettify.css" type="text/css" />
        <script src="js/vendor/prettify/prettify.js" type="text/javascript"></script>
        <script src="js/vendor/prettify/lang-scala.js" type="text/javascript"></script>
        <script src="js/vendor/prettify/lang-sql.js" type="text/javascript"></script>
        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-33205054-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>

    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->


        <div class="bar topbar">
            
  
  

  
  

  
  

  
  

  
  

  
    
  
  

  
  

  
  

  
  

  
  

  
  





<a class="btn page-nav" style="float:left" a href="data-exploration-using-spark.html">

  <i class="icon-arrow-left icon-2x"></i>
</a>

            
  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      
    
  

  
    
    
  

  
    
  

  
    
  

  
    
  

  
    
  





<a class="btn page-nav" style="float:right" href="realtime-processing-with-spark-streaming.html">

  <i class="icon-arrow-right icon-2x"></i>
</a>

            <div href="index.html" id="ampcamp-logo"></div>
            <!--<img src="img/amplab-small.png" alt="AMP Camp Logo" width="150" id="amplab-logo"/>-->
            <div id="topbar-middle">
                <div class="site-title">Hands-on Exercises</div>
                <div class="btn-group">
                    <div class="btn btn-med dropdown-toggle pull-right" data-toggle="dropdown">
                        Data Exploration Using Shark &nbsp; <i class="icon-list-ul icon"></i>
                    </div>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
                    

  <li>
    
      
    
    <a href="index.html">Introduction</a>
  </li>

  <li>
    
      
    
    <a href="logging-into-the-cluster.html">Logging into the Cluster</a>
  </li>

  <li>
    
      
    
    <a href="overview-of-the-exercises.html">Overview Of The Exercises</a>
  </li>

  <li>
    
      
    
    <a href="introduction-to-the-scala-shell.html">Introduction to the Scala Shell</a>
  </li>

  <li>
    
      
      
    
    <a href="data-exploration-using-spark.html">  1. Data Exploration Using Spark</a>
  </li>

  <li>
    
      
      
    
    <a href="data-exploration-using-shark.html">  2. Data Exploration Using Shark</a>
  </li>

  <li>
    
      
      
    
    <a href="realtime-processing-with-spark-streaming.html">  3. Stream Processing w/ Spark Streaming</a>
  </li>

  <li>
    
      
      
    
    <a href="blinkdb.html">  4. Data Exploration Using BlinkDB</a>
  </li>

  <li>
    
      
      
    
    <a href="mli-document-categorization.html">  5. Machine Learning With MLI</a>
  </li>

  <li>
    
      
      
    
    <a href="mesos.html">  6. Mesos - Cluster & Framework Mgmt</a>
  </li>

  <li>
    
      
    
    <a href="where-to-go-from-here.html">Where to Go From Here</a>
  </li>


                  </ul>
                </div>
            </div>
        </div><!--topbar-->
        <div class="container" id="content">
            
            <p>Now that we&#8217;ve had fun with Spark, let&#8217;s try out Shark. Remember Shark is a large-scale data warehouse system that runs on top of Spark and provides a SQL like interface (that is fully compatible with Apache Hive).</p>

<ol>
  <li>
    <p>First, launch the Shark console:</p>

    <pre class="prettyprint lang-bsh">
/root/shark/bin/shark-withinfo
</pre>
  </li>
  <li>
    <p>Similar to Apache Hive, Shark can query external tables (i.e., tables that are not created in Shark).
Before you do any querying, you will need to tell Shark where the data is and define its schema.</p>

    <pre class="prettyprint lang-sql">
shark&gt; create external table wikistats (dt string, project_code string, page_name string, page_views int, bytes int) row format delimited fields terminated by ' ' location '/wiki/pagecounts';
<span class="nocode">
...
Time taken: 0.232 seconds
13/02/05 21:31:25 INFO CliDriver: Time taken: 0.232 seconds</span></pre>

    <p><b>FAQ:</b> If you see the following errors, donâ€™t worry. Things are still working under the hood.</p>

    <pre class="nocode">
12/08/18 21:07:34 ERROR DataNucleus.Plugin: Bundle "org.eclipse.jdt.core" requires "org.eclipse.core.resources" but it cannot be resolved.
12/08/18 21:07:34 ERROR DataNucleus.Plugin: Bundle "org.eclipse.jdt.core" requires "org.eclipse.core.runtime" but it cannot be resolved.
12/08/18 21:07:34 ERROR DataNucleus.Plugin: Bundle "org.eclipse.jdt.core" requires "org.eclipse.text" but it cannot be resolved.</pre>

    <p><b>FAQ:</b> If you see errors like these, you might have copied and pasted a line break, and should be able to remove it to get rid of the errors.</p>

    <pre>13/02/05 21:22:16 INFO parse.ParseDriver: Parsing command: CR
FAILED: Parse Error: line 1:0 cannot recognize input near 'CR' '&lt;EOF&gt;' '&lt;EOF&gt;'</pre>

    <p><b>FAQ:</b> If you partially complete the exercises and then restart them later, your tables will stick around.  You will see errors like this if you try to create them again:</p>

    <pre>FAILED: Error in metadata: AlreadyExistsException(message:Table wikistats already exists)
FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask</pre>

    <p>To fix this, drop the table (<code>wikistats</code> or, introduced shortly, <code>wikistats_cached</code>), then create it again using the same command described above.  You can drop a table with:</p>

    <pre>drop table wikistats;</pre>
  </li>
  <li>
    <p>Let&#8217;s create a table containing all English records and cache it in the cluster&#8217;s memory. Shark automatically caches any table having a name with the suffix &#8220;<code>_cached</code>&#8221;.</p>

    <pre class="prettyprint lang-sql">
shark&gt; create table wikistats_cached as select * from wikistats where project_code="en";
<span class="nocode">
...
Time taken: 127.5 seconds
13/02/05 21:57:34 INFO CliDriver: Time taken: 127.5 seconds</span></pre>
  </li>
  <li>
    <p>Do a simple count to get the number of English records. If you have some familiarity working with databases, note that we us the &#8220;<code>count(1)</code>&#8221; syntax here since in earlier versions of Hive, the more popular &#8220;<code>count(*)</code>&#8221; operation was not supported. The Hive syntax is described in detail in the <a href="https://cwiki.apache.org/confluence/display/Hive/GettingStarted" target="_blank">Hive Getting Started Guide</a>.</p>

    <pre class="prettyprint lang-sql">
shark&gt; select count(1) from wikistats_cached;
<span class="nocode">
...
122352588
Time taken: 7.632 seconds
12/08/18 21:23:13 INFO CliDriver: Time taken: 7.632 seconds</span></pre>
  </li>
  <li>
    <p>Output the total traffic to Wikipedia English pages for each hour between May 7 and May 9, with one line per hour.</p>

    <pre class="prettyprint lang-sql">
shark&gt; select dt, sum(page_views) from wikistats_cached group by dt;
<span class="nocode">
...
20090507-070000	6292754
20090505-120000	7304485
20090506-110000	6609124
Time taken: 12.614 seconds
13/02/05 22:05:18 INFO CliDriver: Time taken: 12.614 seconds</span></pre>
  </li>
  <li>
    <p>In the Spark section, we ran a very expensive query to compute pages that were viewed more than 200,000 times. It is fairly simple to do the same thing in SQL.</p>

    <p>To make the query run faster, we increase the number of reducers used in this query to 50 in the first command. Note that the default number of reducers, which we have been using so far in this section, is 1.</p>

    <pre class="prettyprint lang-sql">
shark&gt; set mapred.reduce.tasks=50;
shark&gt; select page_name, sum(page_views) as views from wikistats_cached group by page_name having views &gt; 200000;
<span class="nocode">
...
index.html      310642
Swine_influenza 534253
404_error/      43822489
YouTube 203378
X-Men_Origins:_Wolverine        204604
Dom_DeLuise     396776
Special:Watchlist       311465
The_Beatles     317708
Special:Search  17657352
Special:Random  5816953
Special:Export  248624
Scrubs_(TV_series)      234855
Cinco_de_Mayo   695817
2009_swine_flu_outbreak 237677
Deadpool_(comics)       382510
Wiki    464935
Special:Randompage      3521336
Main_Page       18730347
Time taken: 68.693 seconds
13/02/26 08:12:42 INFO CliDriver: Time taken: 68.693 seconds</span></pre>
  </li>
  <li>
    <p>With all the warm up, now it is your turn to write queries. Write Hive QL queries to answer the following questions:</p>
  </li>
</ol>

<ul>
  <li>
    <p>Count the number of distinct date/times for English pages</p>

    <div class="solution">
      <pre class="prettyprint lang-sql">
 select count(distinct dt) from wikistats_cached;</pre>
    </div>
  </li>
  <li>
    <p>How many hits are there on pages with Berkeley in the title throughout the entire period?</p>

    <div class="solution">
      <pre class="prettyprint lang-sql">
 select count(page_views) from wikistats_cached where page_name like "%berkeley%";
 /* "%" in SQL is a wildcard matching all characters. */</pre>
    </div>
  </li>
  <li>
    <p>Generate a histogram for the number of hits for each hour on May 6, 2009; sort the output by date/time. Based on the output, which hour is Wikipedia most popular?</p>

    <div class="solution">
      <pre class="prettyprint lang-sql">
 select dt, sum(page_views) from wikistats_cached where dt like "20090506%" group by dt order by dt;</pre>
    </div>
  </li>
</ul>

<p>To exit Shark, type the following at the Shark command line (and don&#8217;t forget the semicolon!).</p>

<pre class="prettyprint lang-sql">
   shark&gt; exit;</pre>

        </div> <!-- /container -->


        <div class="bar bottombar">
            
  
  

  
  

  
  

  
  

  
  

  
    
  
  

  
  

  
  

  
  

  
  

  
  





<a class="btn page-nav" style="float:left" a href="data-exploration-using-spark.html">

  <i class="icon-arrow-left icon-2x"></i>
</a>

            
  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      
    
  

  
    
    
  

  
    
  

  
    
  

  
    
  

  
    
  





<a class="btn page-nav" style="float:right" href="realtime-processing-with-spark-streaming.html">

  <i class="icon-arrow-right icon-2x"></i>
</a>

          <div class="btn-group dropup">
            <a class="btn btn-med" target="_blank" href="https://github.com/amplab/training/issues">
              <i class="icon-exclamation-sign"> </i>
              Submit an issue on GitHub
            </a>
          </div>
            <div class="btn-group dropup">
                <div class="btn btn-med dropdown-toggle" data-toggle="dropdown">
                    Data Exploration Using Shark &nbsp; <i class="icon-list-ul icon"></i>
                </div>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
                    

  <li>
    
      
    
    <a href="index.html">Introduction</a>
  </li>

  <li>
    
      
    
    <a href="logging-into-the-cluster.html">Logging into the Cluster</a>
  </li>

  <li>
    
      
    
    <a href="overview-of-the-exercises.html">Overview Of The Exercises</a>
  </li>

  <li>
    
      
    
    <a href="introduction-to-the-scala-shell.html">Introduction to the Scala Shell</a>
  </li>

  <li>
    
      
      
    
    <a href="data-exploration-using-spark.html">  1. Data Exploration Using Spark</a>
  </li>

  <li>
    
      
      
    
    <a href="data-exploration-using-shark.html">  2. Data Exploration Using Shark</a>
  </li>

  <li>
    
      
      
    
    <a href="realtime-processing-with-spark-streaming.html">  3. Stream Processing w/ Spark Streaming</a>
  </li>

  <li>
    
      
      
    
    <a href="blinkdb.html">  4. Data Exploration Using BlinkDB</a>
  </li>

  <li>
    
      
      
    
    <a href="mli-document-categorization.html">  5. Machine Learning With MLI</a>
  </li>

  <li>
    
      
      
    
    <a href="mesos.html">  6. Mesos - Cluster & Framework Mgmt</a>
  </li>

  <li>
    
      
    
    <a href="where-to-go-from-here.html">Where to Go From Here</a>
  </li>


                </ul>
            </div>
            <div class="site-title">Hands-on Exercises</div>
        </div>

        <script src="js/vendor/jquery-1.8.3.min.js"></script>
        <script src="js/vendor/bootstrap.min.js"></script>
        <!-- Table of contents plugin -->
        <script src="js/vendor/toc.js" type="text/javascript"></script>
        <script src="js/main.js"></script>
    </body>
</html>
