<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" xmlns="http://www.w3.org/1999/html"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Data Exploration Using BlinkDB</title>
        <meta name="description" content="">

        <!--<link rel="stylesheet" href="css/vendor/bootstrap/bootstrap.min.css">-->
        <link rel="stylesheet" href="css/vendor/bootstrap/bootstrap.css">
        <meta name="viewport" content="width=device-width">
        <!--<link rel="stylesheet" href="css/vendor/bootstrap/bootstrap-responsive.min.css">-->
        <link rel="stylesheet" href="css/vendor/bootstrap/bootstrap-responsive.css">
        <link rel="stylesheet" href="css/vendor/font-awesome.min.css">
        <!--[if IE 7]>
        <link rel="stylesheet" href="assets/css/vendorfont-awesome-ie7.min.css">
        <![endif]-->
        <link rel="stylesheet" href="css/main.css">

        <script src="js/vendor/modernizr-2.6.1-respond-1.1.0.min.js"></script>

         <!-- prettify js and CSS, used for code highlighting -->
        <link rel="stylesheet" href="css/vendor/prettify/prettify.css" type="text/css" />
        <script src="js/vendor/prettify/prettify.js" type="text/javascript"></script>
        <script src="js/vendor/prettify/lang-scala.js" type="text/javascript"></script>
        <script src="js/vendor/prettify/lang-sql.js" type="text/javascript"></script>
        <script type="text/javascript">

          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-33205054-1']);
          _gaq.push(['_trackPageview']);

          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();

        </script>

    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->


        <div class="bar topbar">
            
  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
    
  
  

  
  

  
  

  
  





<a class="btn page-nav" style="float:left" a href="day-one-feedback.html">

  <i class="icon-arrow-left icon-2x"></i>
</a>

            
  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      
    
  

  
    
    
  

  
    
  

  
    
  





<a class="btn page-nav" style="float:right" href="mli-document-categorization.html">

  <i class="icon-arrow-right icon-2x"></i>
</a>

            <div href="index.html" id="ampcamp-logo"></div>
            <!--<img src="img/amplab-small.png" alt="AMP Camp Logo" width="150" id="amplab-logo"/>-->
            <div id="topbar-middle">
                <div class="site-title">Hands-on Exercises</div>
                <div class="btn-group">
                    <div class="btn btn-med dropdown-toggle pull-right" data-toggle="dropdown">
                        Data Exploration Using BlinkDB &nbsp; <i class="icon-list-ul icon"></i>
                    </div>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
                    

  <li>
    
      
    
    <a href="index.html">Introduction</a>
  </li>

  <li>
    
      
    
    <a href="logging-into-the-cluster.html">Logging into the Cluster</a>
  </li>

  <li>
    
      
    
    <a href="overview-of-the-exercises.html">Overview Of The Exercises</a>
  </li>

  <li>
    
      
    
    <a href="introduction-to-the-scala-shell.html">Introduction to the Scala Shell</a>
  </li>

  <li>
    
      
      
    
    <a href="data-exploration-using-spark.html">  1. Data Exploration Using Spark</a>
  </li>

  <li>
    
      
      
    
    <a href="data-exploration-using-shark.html">  2. Data Exploration Using Shark</a>
  </li>

  <li>
    
      
      
    
    <a href="realtime-processing-with-spark-streaming.html">  3. Stream Processing w/ Spark Streaming</a>
  </li>

  <li>
    
      
    
    <a href="day-one-feedback.html">Feedback for Day 1</a>
  </li>

  <li>
    
      
      
    
    <a href="blinkdb.html">  4. Data Exploration Using BlinkDB</a>
  </li>

  <li>
    
      
      
    
    <a href="mli-document-categorization.html">  5. Machine Learning With MLI</a>
  </li>

  <li>
    
      
      
    
    <a href="mesos.html">  6. Mesos - Cluster & Framework Mgmt</a>
  </li>

  <li>
    
      
    
    <a href="where-to-go-from-here.html">Where to Go From Here</a>
  </li>


                  </ul>
                </div>
            </div>
        </div><!--topbar-->
        <div class="container" id="content">
            
            <p>BlinkDB is a large-scale data warehouse system like Shark that adds the ability to create and use smaller samples of large datasets to make queries even faster.  Today you’re going to get a sneak peek at an Alpha release of BlinkDB.  We’ll set up BlinkDB and use it to run some SQL queries against the English Wikipedia.  If you’ve already done the Shark exercises, you might notice that some of the exercises are similar.  Don’t worry if you haven’t seen Shark, though - we haven’t assumed that you have.</p>

<p>BlinkDB is in its alpha stage of development, and you may notice some of its limitations.  We’ll mention them as they come up in the tutorial.</p>

<ol>
  <li>
    <p>First, launch the BlinkDB console:</p>

    <pre class="prettyprint lang-bsh">
 /root/blinkdb/bin/blinkdb</pre>
  </li>
  <li>
    <p>Similar to Apache Hive, BlinkDB can query external tables (i.e. tables that are not created in BlinkDB).
Before you do any querying, you will need to tell BlinkDB where the data is and define its schema.</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; create external table wikistats (dt string, project_code string, page_name string, page_views int, bytes int) row format delimited fields terminated by ' ' location '/wiki/pagecounts';
<span class="nocode">
OK
Time taken: 0.232 seconds</span></pre>

    <p><strong>FAQ:</strong> If you see the following errors, don’t worry. Things are still working under the hood.</p>

    <pre class="nocode">
12/08/18 21:07:34 ERROR DataNucleus.Plugin: Bundle "org.eclipse.jdt.core" requires "org.eclipse.core.resources" but it cannot be resolved.
12/08/18 21:07:34 ERROR DataNucleus.Plugin: Bundle "org.eclipse.jdt.core" requires "org.eclipse.core.runtime" but it cannot be resolved.
12/08/18 21:07:34 ERROR DataNucleus.Plugin: Bundle "org.eclipse.jdt.core" requires "org.eclipse.text" but it cannot be resolved.</pre>

    <p><strong>FAQ:</strong> If you see errors like these, you might have copied and pasted a line break, and should be able to remove it to get rid of the errors.</p>

    <pre>13/02/05 21:22:16 INFO parse.ParseDriver: Parsing command: CR
FAILED: Parse Error: line 1:0 cannot recognize input near 'CR' '&lt;EOF&gt;' '&lt;EOF&gt;'</pre>

    <p><strong>FAQ:</strong> If you partially complete the exercises and then restart them later, <em>or</em> if you previously tried out the Shark exercises, your tables will stick around.  You will see errors like this if you try to create them again:</p>

    <pre>FAILED: Error in metadata: AlreadyExistsException(message:Table wikistats already exists)
FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask</pre>

    <p>To fix this, drop the table (<code>wikistats</code> or, introduced shortly, <code>wikistats_cached</code> or <code>wikistats_sample_cached</code>), then create it again using the same command described above.  You can drop a table with:</p>

    <pre>drop table wikistats;</pre>
  </li>
  <li>
    <p>Like Shark, BlinkDB allows tables to be cached in the cluster’s memory for faster access.  Any table having a name with the suffix “_cached” is automatically cached.  We’ll take advantage of caching to speed up queries on the <code>wikistats</code> table.  Create a cached version of it:</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; create table wikistats_cached as select * from wikistats;
<span class="nocode">
Moving data to: hdfs://ec2-107-22-9-64.compute-1.amazonaws.com:9000/user/hive/warehouse/wikistats_cached
OK
Time taken: 56.664 seconds</span></pre>
  </li>
  <li>
    <p>First, check the number of records in the table.  (If you have some familiarity with databases, note that we use the “<code>count(1)</code>” syntax here since in earlier versions of Hive, the more popular “<code>count(*)</code>” operation was not supported. BlinkDB supports most of Hive’s flavor of SQL.  Hive SQL syntax is described in detail in the <a href="https://cwiki.apache.org/confluence/display/Hive/GettingStarted" target="_blank">Hive Getting Started Guide</a>.)</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select count(1) from wikistats_cached;
<span class="nocode">
OK
329641466
Time taken: 27.889 seconds</span></pre>
  </li>
  <li>
    <p>Now let’s create a random sample of this table using BlinkDB’s <code>samplewith</code> operator and cache it in the cluster’s memory.  We’ll use a sample that’s about 1% of the original Wikipedia dataset in size.  This sample will be used to compute <em>approximations</em> to various queries on <code>wikistats_cached</code>.</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; create table wikistats_sample_cached as select * from wikistats_cached samplewith 0.01;
<span class="nocode">
Moving data to: hdfs://ec2-107-22-9-64.compute-1.amazonaws.com:9000/user/hive/warehouse/wikistats_sample_cached
OK
Time taken: 22.703 seconds</span></pre>

    <p>In the Alpha release, we need to tell BlinkDB the size of the sample and of the original table.  First, check the sample’s size.  Since the sample size is random, you may get a slightly different answer than the one listed here.  It should be close to 1% of the original table’s size.</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select count(1) from wikistats_sample_cached;
<span class="nocode">
OK
3294551
Time taken: 3.011 seconds
</span></pre>

    <p>Now declare the sample size.  Replace the number here with the result of the <code>count</code> query you just ran.</p>

    <pre class="prettyprint lang-sql">
set blinkdb.sample.size=3294551; -- (Replace this with the result of your query.)
</pre>

    <p>Finally, declare the original table’s size.</p>

    <pre class="prettyprint lang-sql">
set blinkdb.dataset.size=329641466;</pre>
  </li>
  <li>
    <p>Our first real task is to compute a simple count of the number of English records (i.e., those with “<code>project_code="en"</code>”).  We’re not using our sample yet.</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select count(1) from wikistats_cached where project_code = "en";
<span class="nocode">
OK
122352588
Time taken: 21.632 seconds</span></pre>
  </li>
  <li>
    <p>Now approximate the same count using the sampled table.  In the Alpha release, you need to tell BlinkDB to compute an approximation by prepending “<code>approx_</code>” to your aggregation function.  (Also, only queries that compute <code>count</code>, <code>sum</code>, or <code>average</code> can be approximated.  In the future many more functions, including UDFs, will be approximable.)</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select approx_count(1) from wikistats_sample_cached where project_code = "en";
<span class="nocode">
OK
122340466 +/- 225926.0 (99% Confidence)
Time taken: 2.993 seconds</span></pre>

    <p>Notice that our sampled query produces a slightly incorrect answer, but it runs faster.  Also, the query result now includes some additional text, which tells us how close BlinkDB thinks it is to the true answer. In this case, BlinkDB reports that the interval [122114540, 122566392] (this is just subtracting or adding 225926.0 to 122340466) probably contains the true count.</p>

    <p>Technically, this interval is a .99 confidence interval.  Confidence intervals come with the guarantee that, if you were to repeatedly create new samples using the <code>samplewith</code> operator and then perform this query on each sample, the confidence interval reported by BlinkDB would contain the true answer (122352588) 99% of the time. A simpler (though not entirely correct) interpretation is that there is a 99% chance that the true count is inside the confidence interval.</p>
  </li>
  <li>
    <p>Now we would like to find out the average number of hits on pages with “San Francisco” in the title throughout the entire period:</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select approx_avg(page_views) from wikistats_sample_cached where lcase(page_name) like "%san_francisco%";
<span class="nocode">
OK
3.053745928338762 +/- 0.9373634631550505 (99% Confidence)
Time taken: 12.09 seconds</span></pre>

    <p>You can also compute an exact answer by running the same query on the table <code>wikistats_cached</code>, replacing “<code>approx_avg</code>” with “<code>avg</code>”:</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select avg(page_views) from wikistats_cached where lcase(page_name) like "%san_francisco%";
<span class="nocode">
OK
3.0695254665165628
Time taken: 56.802 seconds</span></pre>
  </li>
  <li>
    <p>Let’s dive a little further into traffic patterns on Wikipedia.  First, check which time intervals had the most traffic:</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select dt, approx_sum(page_views) as views from wikistats_sample_cached group by dt order by views;
<span class="nocode">
OK
20090505-050000	1.0132954790026326E7 +/- 140528.0 (99% Confidence)
20090505-060000	1.0566967190060902E7 +/- 143176.0 (99% Confidence)
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
20090506-170000	2.5080237868203986E7 +/- 337587.0 (99% Confidence)
20090506-120000	4.075047502715797E7 +/- 907448.0 (99% Confidence)
Time taken: 1.195 seconds</span></pre>

    <p><b>NOTE:</b> Currently BlinkDB alpha-0.1.0 only supports lexographic ordering using the <code>orderby</code> operator. We will introduce numerical ordering in alpha-0.2.0.</p>
  </li>
  <li>
    <p>The hour <code>"20090506-120000"</code> seems to be at or near the top.  Now let’s see which project codes (roughly, which languages) contributed to this:</p>
  </li>
</ol>

<pre class="prettyprint lang-sql">
   blinkdb&gt; select project_code, approx_sum(page_views) as views from wikistats_sample_cached where
   dt="20090506-120000" group by project_code;
   <span class="nocode">
   OK
   vi.d	10197.941673238138 +/- 2724.0 (99% Confidence)
   sr	10297.921493564003 +/- 2984.0 (99% Confidence)
   . . . . . . . . . . . . . . . . . . . . . . . . . .
   . . . . . . . . . . . . . . . . . . . . . . . . . .
   io.d	999.798203258641 +/- 859.0 (99% Confidence)
   nds	999.798203258641 +/- 974.0 (99% Confidence)
   Time taken: 1.407 seconds</span></pre>

<ol>
  <li>
    <p>We might also be interested in whether the amount of traffic on a project matches its page count:</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select project_code, approx_count(1) as num_pages, approx_sum(page_views) as views from
wikistats_sample_cached where dt="20090506-160000" group by project_code;
<span class="nocode">
OK
fr	315836 +/- 14463.0 (99% Confidence)  1003897.3758920014 +/- 45994.0 (99% Confidence)
de.b	5798 +/- 1961.0 (99% Confidence) 	10397.901313889866 +/- 3516.0 (99% Confidence)
. . . . . . . . . . . . . . . . . . . . . . . . . .. . . . . . . . . . . . . . . . . . . .
. . . . . . . . . . . . . . . . . . . . . . . . . .. . . . . . . . . . . . . . . . . . . .
vi.b	699 +/- 682.0 (99% Confidence) 	999.798203258641 +/- 974.0 (99% Confidence)
kk	699 +/- 682.0 (99% Confidence) 	999.798203258641 +/- 974.0 (99% Confidence)
Time taken: 0.907 seconds</span></pre>
  </li>
  <li>
    <p>However, the random sampling used by BlinkDB doesn’t always work well. For instance, try computing the average number of hits on all pages:</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select approx_avg(page_views) from wikistats_sample_cached;
<span class="nocode">
OK
3.6420454545454546 +/- 1.7610655103860877 (99% Confidence)
Time taken: 3.407 seconds</span></pre>

    <p>Also try computing the true average on the original table.  You’ll probably notice that the 99% confidence interval provided by BlinkDB doesn’t cover the true answer.</p>
  </li>
  <li>
    <p>Let’s investigate this a bit further.  The kind of sampling supported in the Alpha release (simple random sampling) typically works poorly on data that contains large, important outliers.  Let’s check what the raw distribution of <code>page_views</code> looks like.  (You can also try this on <code>wikistats_sample_cached</code>; percentiles on samples are not officially supported yet, but they work quite well!)</p>

    <pre class="prettyprint lang-sql">
blinkdb&gt; select percentile_approx(page_views, array(0.01, 0.1, 0.3, 0.5, 0.7, 0.9, 0.99, 0.999))
as page_views_percentiles  from wikistats_cached;
<span class="nocode">
OK
[1.0,1.0,1.0,1.0,1.9999999999999998,4.867578875914043,35.00000000000001,151.9735162220546]
Time taken: 31.241 seconds</span></pre>

    <p>Note that <code>percentile_approx</code> is not one of the BlinkDB approximation operators (which are <em>prefixed</em> by “<code>approx_</code>”).  It is a normal Hive SQL operator that computes approximate percentiles on a given column.</p>

    <p>Most pages have only a few views, but there are some pages with a very large number of views.  If a sample misses one of these outliers, it will look very different from the original table, and accuracy of both approximations and confidence intervals will suffer.</p>
  </li>
  <li>
    <p>To exit BlinkDB, type the following at the BlinkDB command line (and don’t forget the semicolon!).</p>

    <pre class="prettyprint lang-bsh">
blinkdb&gt; exit;</pre>
  </li>
</ol>

<!--15. With the warmup out of the way, now it is your turn to write queries. Write Hive QL queries to answer the following questions:

   - Count the number of distinct project_codes.  Try the same query on the original table and compare the results.  Notice that the kind of sampling available in the Alpha is not very effective for queries that depend on rare values, like `count distinct`. FIXME

   <div class="solution" markdown="1">
   <pre class="prettyprint lang-sql">
   select count(distinct project_code) from wikistats_sample_cached;</pre>
   </div>

   - Which day (5th, 6th or 7th May 2009) was the most popular in terms of the number of hits?

   <div class="solution" markdown="1">
   <pre class="prettyprint lang-sql">
   select approx_sum(page_views) from wikistats_sample_cached where dt like "20090505%";</pre>
   </div>

   <div class="solution" markdown="1">
   <pre class="prettyprint lang-sql">
   select approx_sum(page_views) from wikistats_sample_cached where dt like "20090506%";</pre>
   </div>

   <div class="solution" markdown="1">
   <pre class="prettyprint lang-sql">
   select approx_sum(page_views) from wikistats_sample_cached where dt like "20090507%";</pre>
   </div>

   - What was the total traffic to Wikipedia pages on May 7 between 7AM - 8AM? FIXME

      <pre class="prettyprint lang-sql">
      blinkdb> select approx_sum(page_views) from wikistats_sample_cached where dt="20090507-070000";
      <span class="nocode">
      OK
      1.1811077507224506E7 +/- 147736.0 (99% Confidence)
      Time taken: 0.649 seconds</span></pre>

      As before, you can also compute an exact answer by running the same query on the table `wikistats`, replacing "`approx_sum`" with "`sum`".

       <pre class="prettyprint lang-sql">
       blinkdb> select sum(page_views) from wikistats where dt="20090507-070000";
       <span class="nocode">
        OK
   	13098805
   	Time taken: 19.465 seconds</span></pre>
-->

        </div> <!-- /container -->


        <div class="bar bottombar">
            
  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
    
  
  

  
  

  
  

  
  





<a class="btn page-nav" style="float:left" a href="day-one-feedback.html">

  <i class="icon-arrow-left icon-2x"></i>
</a>

            
  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      
    
  

  
    
    
  

  
    
  

  
    
  





<a class="btn page-nav" style="float:right" href="mli-document-categorization.html">

  <i class="icon-arrow-right icon-2x"></i>
</a>

          <div class="btn-group dropup">
            <a class="btn btn-med" target="_blank" href="https://github.com/amplab/training/issues">
              <i class="icon-exclamation-sign"> </i>
              Submit an issue on GitHub
            </a>
          </div>
            <div class="btn-group dropup">
                <div class="btn btn-med dropdown-toggle" data-toggle="dropdown">
                    Data Exploration Using BlinkDB &nbsp; <i class="icon-list-ul icon"></i>
                </div>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
                    

  <li>
    
      
    
    <a href="index.html">Introduction</a>
  </li>

  <li>
    
      
    
    <a href="logging-into-the-cluster.html">Logging into the Cluster</a>
  </li>

  <li>
    
      
    
    <a href="overview-of-the-exercises.html">Overview Of The Exercises</a>
  </li>

  <li>
    
      
    
    <a href="introduction-to-the-scala-shell.html">Introduction to the Scala Shell</a>
  </li>

  <li>
    
      
      
    
    <a href="data-exploration-using-spark.html">  1. Data Exploration Using Spark</a>
  </li>

  <li>
    
      
      
    
    <a href="data-exploration-using-shark.html">  2. Data Exploration Using Shark</a>
  </li>

  <li>
    
      
      
    
    <a href="realtime-processing-with-spark-streaming.html">  3. Stream Processing w/ Spark Streaming</a>
  </li>

  <li>
    
      
    
    <a href="day-one-feedback.html">Feedback for Day 1</a>
  </li>

  <li>
    
      
      
    
    <a href="blinkdb.html">  4. Data Exploration Using BlinkDB</a>
  </li>

  <li>
    
      
      
    
    <a href="mli-document-categorization.html">  5. Machine Learning With MLI</a>
  </li>

  <li>
    
      
      
    
    <a href="mesos.html">  6. Mesos - Cluster & Framework Mgmt</a>
  </li>

  <li>
    
      
    
    <a href="where-to-go-from-here.html">Where to Go From Here</a>
  </li>


                </ul>
            </div>
            <div class="site-title">Hands-on Exercises</div>
        </div>

        <script src="js/vendor/jquery-1.8.3.min.js"></script>
        <script src="js/vendor/bootstrap.min.js"></script>
        <!-- Table of contents plugin -->
        <script src="js/vendor/toc.js" type="text/javascript"></script>
        <script src="js/main.js"></script>
    </body>
</html>
